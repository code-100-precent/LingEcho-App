# WebRTC + WebSocket è¯­éŸ³AIäº¤äº’åè®®è§„èŒƒ

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [åè®®æ¶æ„](#åè®®æ¶æ„)
3. [è¿æ¥å»ºç«‹æµç¨‹](#è¿æ¥å»ºç«‹æµç¨‹)
4. [æ¶ˆæ¯æ ¼å¼å®šä¹‰](#æ¶ˆæ¯æ ¼å¼å®šä¹‰)
5. [çŠ¶æ€æœºå®šä¹‰](#çŠ¶æ€æœºå®šä¹‰)
6. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
7. [ç¤ºä¾‹æµç¨‹](#ç¤ºä¾‹æµç¨‹)

---

## æ¦‚è¿°

æœ¬åè®®å®šä¹‰äº†åŸºäº WebRTC å’Œ WebSocket çš„è¯­éŸ³AIäº¤äº’ç³»ç»Ÿçš„å®Œæ•´é€šä¿¡è§„èŒƒã€‚

### æ ¸å¿ƒç»„ä»¶

- **WebSocket**: ç”¨äºä¿¡ä»¤ä¼ è¾“å’Œæ–‡æœ¬æ¶ˆæ¯äº¤äº’
- **WebRTC**: ç”¨äºå®æ—¶éŸ³é¢‘ä¼ è¾“ï¼ˆåŒå‘ï¼‰
- **ä¿¡ä»¤æœåŠ¡å™¨**: å¤„ç† WebRTC è¿æ¥åå•†
- **AIæœåŠ¡**: å¤„ç†è¯­éŸ³è¯†åˆ«ã€æ–‡æœ¬ç†è§£å’Œè¯­éŸ³åˆæˆ

### é€šä¿¡æ¨¡å¼

1. **ä¿¡ä»¤é€šé“ (WebSocket)**: 
   - WebRTC è¿æ¥å»ºç«‹å’Œåå•†
   - æ–‡æœ¬æ¶ˆæ¯ä¼ è¾“ï¼ˆç”¨æˆ·è¾“å…¥ã€AIå›å¤ï¼‰
   - ç³»ç»Ÿæ§åˆ¶æ¶ˆæ¯

2. **åª’ä½“é€šé“ (WebRTC)**:
   - å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šç”¨æˆ·è¯­éŸ³è¾“å…¥
   - æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šAIè¯­éŸ³å›å¤

---

## åè®®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚                    â”‚  Go Server  â”‚
â”‚   Client    â”‚                    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
       â”‚  â”‚   WebSocket (ä¿¡ä»¤é€šé“)        â”‚ â”‚
       â”‚  â”‚   - è¿æ¥å»ºç«‹                  â”‚ â”‚
       â”‚  â”‚   - WebRTCåå•†                â”‚ â”‚
       â”‚  â”‚   - æ–‡æœ¬æ¶ˆæ¯                  â”‚ â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
       â”‚                                   â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
       â”‚  â”‚   WebRTC (åª’ä½“é€šé“)          â”‚ â”‚
       â”‚  â”‚   - éŸ³é¢‘ä¼ è¾“ (åŒå‘)           â”‚ â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
       â”‚                                   â”‚
```

---

## è¿æ¥å»ºç«‹æµç¨‹

### é˜¶æ®µ1: WebSocket è¿æ¥å»ºç«‹

```
Client                          Server
  â”‚                               â”‚
  â”‚â”€â”€â”€ WebSocket Connect â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ init (session_id) â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
```

### é˜¶æ®µ2: WebRTC è¿æ¥å»ºç«‹

```
Client                          Server
  â”‚                               â”‚
  â”‚â”€â”€â”€ offer (SDP + candidates) â”€>â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ answer (SDP + candidates) â”€â”‚
  â”‚                               â”‚
  â”‚â”€â”€â”€ ICE candidates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€ ICE candidates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ connected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
```

### é˜¶æ®µ3: åª’ä½“ä¼ è¾“å°±ç»ª

```
Client                          Server
  â”‚                               â”‚
  â”‚â”€â”€â”€ ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
  â”‚  [å¼€å§‹éŸ³é¢‘ä¼ è¾“]                â”‚
  â”‚                               â”‚
```

---

## æ¶ˆæ¯æ ¼å¼å®šä¹‰

### åŸºç¡€æ¶ˆæ¯ç»“æ„

æ‰€æœ‰ WebSocket æ¶ˆæ¯éƒ½éµå¾ªä»¥ä¸‹ JSON æ ¼å¼ï¼š

```json
{
  "type": "message_type",
  "session_id": "session_xxx",
  "timestamp": 1234567890,
  "data": {},
  "error": null
}
```

### æ¶ˆæ¯ç±»å‹å®šä¹‰

#### 1. è¿æ¥ç®¡ç†æ¶ˆæ¯

##### `init` - åˆå§‹åŒ–æ¶ˆæ¯ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

æœåŠ¡å™¨åœ¨ WebSocket è¿æ¥å»ºç«‹åç«‹å³å‘é€ã€‚

```json
{
  "type": "init",
  "session_id": "session_1703123456789",
  "timestamp": 1703123456789,
  "data": {
    "server_version": "1.0.0",
    "supported_codecs": ["pcma", "opus"],
    "max_audio_duration": 30000
  }
}
```

##### `connected` - è¿æ¥ç¡®è®¤ï¼ˆåŒå‘ï¼‰

WebRTC è¿æ¥å»ºç«‹æˆåŠŸåå‘é€ã€‚

```json
{
  "type": "connected",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "connection_state": "connected",
    "audio_codec": "pcma",
    "sample_rate": 8000
  }
}
```

##### `disconnect` - æ–­å¼€è¿æ¥ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "disconnect",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "reason": "user_requested" | "timeout" | "error"
  }
}
```

#### 2. WebRTC ä¿¡ä»¤æ¶ˆæ¯

##### `offer` - WebRTC Offerï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

```json
{
  "type": "offer",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "sdp": "v=0\r\no=- 123456789 2 IN IP4...",
    "candidates": [
      "candidate:1 1 UDP 2130706431 192.168.1.100 54321 typ host",
      "candidate:2 1 UDP 1694498815 203.0.113.1 54322 typ srflx"
    ]
  }
}
```

##### `answer` - WebRTC Answerï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

```json
{
  "type": "answer",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "sdp": "v=0\r\no=- 987654321 2 IN IP4...",
    "candidates": [
      "candidate:1 1 UDP 2130706431 192.168.1.200 54323 typ host"
    ]
  }
}
```

##### `ice_candidate` - ICE å€™é€‰è€…ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "ice_candidate",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "candidate": "candidate:1 1 UDP 2130706431 192.168.1.100 54321 typ host",
    "sdp_mid": "0",
    "sdp_mline_index": 0
  }
}
```

#### 3. æ–‡æœ¬æ¶ˆæ¯ï¼ˆAIäº¤äº’ï¼‰

##### `text_message` - æ–‡æœ¬æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

ç”¨æˆ·å‘é€æ–‡æœ¬æ¶ˆæ¯ç»™AIã€‚

```json
{
  "type": "text_message",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "message_id": "msg_001",
    "text": "ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹äº§å“ä¿¡æ¯",
    "language": "zh-CN"
  }
}
```

##### `text_response` - AIæ–‡æœ¬å›å¤ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

AIè¿”å›æ–‡æœ¬å›å¤ã€‚

```json
{
  "type": "text_response",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "message_id": "msg_001",
    "response_id": "resp_001",
    "text": "æ‚¨å¥½ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æ‚¨æƒ³äº†è§£å“ªæ–¹é¢çš„äº§å“ä¿¡æ¯ï¼Ÿ",
    "language": "zh-CN",
    "confidence": 0.95
  }
}
```

#### 4. è¯­éŸ³è¯†åˆ«æ¶ˆæ¯

##### `asr_start` - å¼€å§‹è¯­éŸ³è¯†åˆ«ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

é€šçŸ¥æœåŠ¡å™¨å¼€å§‹æ¥æ”¶éŸ³é¢‘è¿›è¡Œè¯†åˆ«ã€‚

```json
{
  "type": "asr_start",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "language": "zh-CN",
    "format": "pcma",
    "sample_rate": 8000
  }
}
```

##### `asr_result` - è¯­éŸ³è¯†åˆ«ç»“æœï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

```json
{
  "type": "asr_result",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "result_id": "asr_001",
    "text": "ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹äº§å“ä¿¡æ¯",
    "is_final": true,
    "confidence": 0.92,
    "language": "zh-CN",
    "start_time": 0,
    "end_time": 2500
  }
}
```

##### `asr_interim` - ä¸´æ—¶è¯†åˆ«ç»“æœï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

```json
{
  "type": "asr_interim",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "result_id": "asr_001",
    "text": "ä½ å¥½ï¼Œæˆ‘æƒ³",
    "is_final": false,
    "confidence": 0.85
  }
}
```

##### `asr_stop` - åœæ­¢è¯­éŸ³è¯†åˆ«ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

```json
{
  "type": "asr_stop",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {}
}
```

#### 5. è¯­éŸ³åˆæˆæ¶ˆæ¯

##### `tts_request` - è¯·æ±‚è¯­éŸ³åˆæˆï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

```json
{
  "type": "tts_request",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "request_id": "tts_001",
    "text": "æ‚¨å¥½ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚",
    "voice": "female_zh",
    "speed": 1.0,
    "pitch": 1.0
  }
}
```

##### `tts_start` - å¼€å§‹æ’­æ”¾TTSï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

```json
{
  "type": "tts_start",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "request_id": "tts_001",
    "audio_format": "pcma",
    "sample_rate": 8000
  }
}
```

##### `tts_complete` - TTSæ’­æ”¾å®Œæˆï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

```json
{
  "type": "tts_complete",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "request_id": "tts_001",
    "duration_ms": 2500
  }
}
```

#### 6. æ§åˆ¶æ¶ˆæ¯

##### `ready` - å‡†å¤‡å°±ç»ªï¼ˆåŒå‘ï¼‰

è¡¨ç¤ºWebRTCè¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“éŸ³é¢‘ã€‚

```json
{
  "type": "ready",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "direction": "send" | "receive" | "both"
  }
}
```

##### `ping` - å¿ƒè·³æ£€æµ‹ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "ping",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {}
}
```

##### `pong` - å¿ƒè·³å“åº”ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "pong",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "server_time": 1703123456789
  }
}
```

##### `error` - é”™è¯¯æ¶ˆæ¯ï¼ˆåŒå‘ï¼‰

```json
{
  "type": "error",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "code": "ERROR_CODE",
    "message": "Error description",
    "details": {}
  }
}
```

---

## çŠ¶æ€æœºå®šä¹‰

### å®¢æˆ·ç«¯çŠ¶æ€æœº

```
[Disconnected]
    â”‚
    â”‚ WebSocket Connect
    â–¼
[Connecting]
    â”‚
    â”‚ Receive init
    â–¼
[Initialized]
    â”‚
    â”‚ Send offer
    â–¼
[Offer Sent]
    â”‚
    â”‚ Receive answer
    â–¼
[Answer Received]
    â”‚
    â”‚ Exchange ICE candidates
    â”‚ WebRTC Connected
    â–¼
[WebRTC Connected]
    â”‚
    â”‚ Send/Receive ready
    â–¼
[Ready]
    â”‚
    â”‚ Start audio transmission
    â–¼
[Active]
    â”‚
    â”‚ Disconnect
    â–¼
[Disconnected]
```

### æœåŠ¡å™¨çŠ¶æ€æœº

```
[Waiting]
    â”‚
    â”‚ WebSocket Connect
    â”‚ Send init
    â–¼
[Initialized]
    â”‚
    â”‚ Receive offer
    â–¼
[Offer Received]
    â”‚
    â”‚ Send answer
    â–¼
[Answer Sent]
    â”‚
    â”‚ Exchange ICE candidates
    â”‚ WebRTC Connected
    â–¼
[WebRTC Connected]
    â”‚
    â”‚ Receive/Send ready
    â–¼
[Ready]
    â”‚
    â”‚ Start audio processing
    â–¼
[Active]
    â”‚
    â”‚ Disconnect
    â–¼
[Waiting]
```

---

## é”™è¯¯å¤„ç†

### é”™è¯¯ä»£ç å®šä¹‰

| é”™è¯¯ä»£ç  | æè¿° | å¤„ç†æ–¹å¼ |
|---------|------|---------|
| `ERR_CONNECTION_FAILED` | è¿æ¥å¤±è´¥ | å®¢æˆ·ç«¯é‡è¯•è¿æ¥ |
| `ERR_INVALID_MESSAGE` | æ— æ•ˆæ¶ˆæ¯æ ¼å¼ | å¿½ç•¥æ¶ˆæ¯ï¼Œè®°å½•æ—¥å¿— |
| `ERR_SESSION_NOT_FOUND` | ä¼šè¯ä¸å­˜åœ¨ | é‡æ–°å»ºç«‹è¿æ¥ |
| `ERR_WEBRTC_FAILED` | WebRTCè¿æ¥å¤±è´¥ | é‡æ–°åå•† |
| `ERR_AUDIO_ENCODE_FAILED` | éŸ³é¢‘ç¼–ç å¤±è´¥ | åœæ­¢éŸ³é¢‘ä¼ è¾“ |
| `ERR_ASR_FAILED` | è¯­éŸ³è¯†åˆ«å¤±è´¥ | ç»§ç»­æ¥æ”¶ï¼Œè®°å½•é”™è¯¯ |
| `ERR_TTS_FAILED` | è¯­éŸ³åˆæˆå¤±è´¥ | è¿”å›æ–‡æœ¬æ¶ˆæ¯ |
| `ERR_TIMEOUT` | æ“ä½œè¶…æ—¶ | é‡è¯•æˆ–æ–­å¼€è¿æ¥ |
| `ERR_RATE_LIMIT` | è¯·æ±‚é¢‘ç‡è¿‡é«˜ | å®¢æˆ·ç«¯é™ä½è¯·æ±‚é¢‘ç‡ |

### é”™è¯¯æ¶ˆæ¯æ ¼å¼

```json
{
  "type": "error",
  "session_id": "session_xxx",
  "timestamp": 1703123456789,
  "data": {
    "code": "ERR_WEBRTC_FAILED",
    "message": "WebRTC connection failed",
    "details": {
      "error_type": "ice_connection_failed",
      "retry_after": 5000
    }
  }
}
```

---

## ç¤ºä¾‹æµç¨‹

### å®Œæ•´äº¤äº’æµç¨‹ç¤ºä¾‹

#### 1. è¿æ¥å»ºç«‹

```
Client                          Server
  â”‚                               â”‚
  â”‚â”€â”€â”€ WebSocket Connect â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚   {session_id: "sess_001"}    â”‚
  â”‚                               â”‚
  â”‚â”€â”€â”€ offer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚   {sdp, candidates}           â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚   {sdp, candidates}           â”‚
  â”‚                               â”‚
  â”‚â”€â”€â”€ ice_candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€ ice_candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ connected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚â”€â”€â”€ ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€ ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
```

#### 2. è¯­éŸ³äº¤äº’æµç¨‹

```
Client                          Server
  â”‚                               â”‚
  â”‚â”€â”€â”€ asr_start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚
  â”‚  [WebRTC Audio Stream] â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ asr_interim â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚   {text: "ä½ å¥½"}              â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ asr_result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚   {text: "ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£"}    â”‚
  â”‚                               â”‚
  â”‚â”€â”€â”€ asr_stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                               â”‚
  â”‚                               â”‚ [AI Processing]
  â”‚                               â”‚
  â”‚<â”€â”€â”€ text_response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚   {text: "æ‚¨å¥½ï¼å¾ˆé«˜å…´..."}   â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ tts_start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ [WebRTC Audio Stream] â”€â”€â”€â”€â”‚
  â”‚                               â”‚
  â”‚<â”€â”€â”€ tts_complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚
```

#### 3. æ–‡æœ¬äº¤äº’æµç¨‹

```
Client                          Server
  â”‚                               â”‚
  â”‚â”€â”€â”€ text_message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚   {text: "äº§å“ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ"}  â”‚
  â”‚                               â”‚
  â”‚                               â”‚ [AI Processing]
  â”‚                               â”‚
  â”‚<â”€â”€â”€ text_response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚   {text: "äº§å“ä»·æ ¼æ˜¯..."}     â”‚
  â”‚                               â”‚
```

---

## å®ç°å»ºè®®

### å®¢æˆ·ç«¯å®ç°è¦ç‚¹

1. **è¿æ¥ç®¡ç†**
   - å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶
   - å¤„ç†ç½‘ç»œä¸­æ–­å’Œæ¢å¤
   - ç»´æŠ¤è¿æ¥çŠ¶æ€

2. **æ¶ˆæ¯å¤„ç†**
   - å®ç°æ¶ˆæ¯é˜Ÿåˆ—
   - å¤„ç†æ¶ˆæ¯è¶…æ—¶
   - å®ç°æ¶ˆæ¯é‡è¯•æœºåˆ¶

3. **WebRTCç®¡ç†**
   - ç›‘æ§è¿æ¥çŠ¶æ€
   - å¤„ç†ICEè¿æ¥å¤±è´¥
   - å®ç°éŸ³é¢‘æµæ§åˆ¶

4. **é”™è¯¯å¤„ç†**
   - å®ç°é”™è¯¯æ¢å¤æœºåˆ¶
   - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
   - æ—¥å¿—è®°å½•

### æœåŠ¡å™¨å®ç°è¦ç‚¹

1. **ä¼šè¯ç®¡ç†**
   - ç»´æŠ¤å®¢æˆ·ç«¯ä¼šè¯
   - å®ç°ä¼šè¯è¶…æ—¶æ¸…ç†
   - å¤„ç†å¹¶å‘è¿æ¥

2. **éŸ³é¢‘å¤„ç†**
   - éŸ³é¢‘æµæ¥æ”¶å’Œç¼“å†²
   - å®æ—¶è¯­éŸ³è¯†åˆ«
   - éŸ³é¢‘ç¼–ç å’Œä¼ è¾“

3. **AIé›†æˆ**
   - æ–‡æœ¬ç†è§£å¤„ç†
   - è¯­éŸ³åˆæˆç®¡ç†
   - å“åº”é˜Ÿåˆ—ç®¡ç†

4. **æ€§èƒ½ä¼˜åŒ–**
   - éŸ³é¢‘æµç¼“å†²ä¼˜åŒ–
   - å¹¶å‘å¤„ç†ä¼˜åŒ–
   - èµ„æºæ¸…ç†

---

## å®‰å…¨è€ƒè™‘

1. **è®¤è¯æˆæƒ**
   - WebSocketè¿æ¥éœ€è¦tokenéªŒè¯
   - ä¼šè¯IDéœ€è¦åŠ å¯†
   - å®ç°è®¿é—®é¢‘ç‡é™åˆ¶

2. **æ•°æ®å®‰å…¨**
   - æ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“
   - éŸ³é¢‘æ•°æ®éšç§ä¿æŠ¤
   - æ—¥å¿—è„±æ•å¤„ç†

3. **é˜²æŠ¤æªæ–½**
   - DDoSé˜²æŠ¤
   - è¾“å…¥éªŒè¯
   - SQLæ³¨å…¥é˜²æŠ¤

---

## ç‰ˆæœ¬ç®¡ç†

åè®®ç‰ˆæœ¬é€šè¿‡ `server_version` å­—æ®µåœ¨ `init` æ¶ˆæ¯ä¸­ä¼ é€’ã€‚

å½“å‰ç‰ˆæœ¬: **v1.0.0**

### ç‰ˆæœ¬å…¼å®¹æ€§

- ä¸»ç‰ˆæœ¬å·å˜æ›´ï¼šä¸å…¼å®¹çš„åè®®å˜æ›´
- æ¬¡ç‰ˆæœ¬å·å˜æ›´ï¼šå‘åå…¼å®¹çš„åŠŸèƒ½æ·»åŠ 
- ä¿®è®¢ç‰ˆæœ¬å·å˜æ›´ï¼šå‘åå…¼å®¹çš„bugä¿®å¤

---

## é™„å½•

### A. æ¶ˆæ¯ç±»å‹é€ŸæŸ¥è¡¨

| ç±»å‹ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| `init` | Sâ†’C | åˆå§‹åŒ–æ¶ˆæ¯ |
| `offer` | Câ†’S | WebRTC Offer |
| `answer` | Sâ†’C | WebRTC Answer |
| `ice_candidate` | åŒå‘ | ICEå€™é€‰è€… |
| `connected` | åŒå‘ | è¿æ¥ç¡®è®¤ |
| `ready` | åŒå‘ | å‡†å¤‡å°±ç»ª |
| `text_message` | Câ†’S | æ–‡æœ¬æ¶ˆæ¯ |
| `text_response` | Sâ†’C | æ–‡æœ¬å›å¤ |
| `asr_start` | Câ†’S | å¼€å§‹è¯†åˆ« |
| `asr_result` | Sâ†’C | è¯†åˆ«ç»“æœ |
| `asr_interim` | Sâ†’C | ä¸´æ—¶ç»“æœ |
| `asr_stop` | Câ†’S | åœæ­¢è¯†åˆ« |
| `tts_request` | Câ†’S | TTSè¯·æ±‚ |
| `tts_start` | Sâ†’C | TTSå¼€å§‹ |
| `tts_complete` | Sâ†’C | TTSå®Œæˆ |
| `ping` | åŒå‘ | å¿ƒè·³ |
| `pong` | åŒå‘ | å¿ƒè·³å“åº” |
| `error` | åŒå‘ | é”™è¯¯æ¶ˆæ¯ |
| `disconnect` | åŒå‘ | æ–­å¼€è¿æ¥ |

### B. éŸ³é¢‘æ ¼å¼è§„èŒƒ

- **ç¼–ç æ ¼å¼**: PCMA (G.711 A-law) æˆ– OPUS
- **é‡‡æ ·ç‡**: 8000 Hz (PCMA) æˆ– 16000/48000 Hz (OPUS)
- **å£°é“**: å•å£°é“ (Mono)
- **ä½æ·±åº¦**: 8-bit (PCMA) æˆ– 16-bit (OPUS)
- **å¸§å¤§å°**: 20ms

### C. æ—¶é—´æˆ³è§„èŒƒ

- æ‰€æœ‰æ—¶é—´æˆ³ä½¿ç”¨ Unix æ¯«ç§’æ—¶é—´æˆ³
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ—¶é—´éœ€è¦åŒæ­¥ï¼ˆNTPï¼‰
- ç›¸å¯¹æ—¶é—´ä½¿ç”¨æ¯«ç§’ä¸ºå•ä½

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2024-01-XX  
**ç»´æŠ¤è€…**: LingEcho Team

